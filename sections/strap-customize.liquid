<div class="section--starp-customization">
    <div class="page-width">
        <div class="starp-customization">
            <div class="starp-content">
                <div class="header-section">
                    {% if section.settings.heading != blank %}<div class="heading">{{ section.settings.heading }}</div>{% endif %}
                    {% if section.settings.desc != blank %}<div class="desc">{{ section.settings.desc }}</div>{% endif %}
                </div>
                {% if section.settings.watch_title %}
                    <div class="watch__content">
                        <div class="title">{{ section.settings.watch_title }}</div>
                        <div class="text">{{ section.settings.watch_text }}</div>
                        <div class="strapenginescreen">
                            <div class="strapengine__collection"></div>
                        </div>
                    </div>
                {% endif %}
                {% if section.settings.strap_title %}
                    <div class="strap__content">
                        <div class="title">{{ section.settings.strap_title }}</div>
                        <div class="text">{{ section.settings.strap_text }}</div>
                        <div class="strapengine__strap"></div>
                    </div>
                {% endif %}
                {% if section.settings.extra_title %}
                    <div class="strap__content">
                        <div class="title">{{ section.settings.extra_title }}</div>
                        <div class="text">{{ section.settings.extra_text }}</div>
                    </div>
                {% endif %}
                {% if section.settings.bottom_desc != blank %}<div class="desc">{{ section.settings.bottom_desc }}</div>{% endif %}
                <div class="strap-add-to-cart">
                    {% assign product = all_products["orange-silicone-strap-24mm-silver-buckle"] %}
                    {%- assign product_form_id = 'product-form-' | append: section.id -%}
                    {%- form 'product',
                        product,
                        id: product_form_id,
                        class: 'form',
                        novalidate: 'novalidate',
                        data-type: 'add-to-cart-form'
                    -%}
                        <input
                            type="hidden"
                            name="id"
                            value="{{ product.selected_or_first_available_variant.id }}"
                            class="product-variant-id"
                        >
                        <button type="submit" name="add" class="product-form__submit button button--primary" disabled="" style="display:none;">
                            ADD STRAP TO CART
                        </button>
                    {%- endform -%}
                    {% if section.settings.button_link_1 != blank %}
                        <div class="choose--btn">
                            <a class="button button--primary" href="{{ section.settings.button_link_1 }}">
                                {{ section.settings.button_label_1 }}
                            </a>
                        </div>
                    {% endif %}
                    {% if section.settings.button_link_2 != blank %}
                        <div class="strap--details" style="display:none;">
                            <a class="button button--secondary" href="{{ section.settings.button_link_2 }}">
                                {{ section.settings.button_label_2 }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="starp-img">
                <div class="starp-img-inner loading">
                    <div class="model-img"></div>
                    <div class="strap__image"><img src="{{ section.settings.strap_img | img_url: 'master' }}" height="100%" width="100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // STRAP ENGINE OBJECT
    const strapEngine = (function(){

        const params = {
            data : null,
            jsonRowData: null,
            jsonData: [],
            selectedCollection: '',
            selectedModel: '',
        }

        const int = () => {
            
            console.log('strap init');

            // add output contianer
            {% comment %} document.body.insertAdjacentHTML('beforeend', '<div class="strapenginescreen"><div class="strapengine"></div></div>'); {% endcomment %}
           
            readData();
        }

        const readData = () => {

            const sheetUrl = 'https://docs.google.com/spreadsheets/d/1-x59uEuFZVtK-tZoUSn4koPptZ2YAiFmLeskw9eA4E4/pub?gid=0&single=true&output=csv';

        
            fetch(sheetUrl)
                .then(response => response.text())
                .then(csv => {
                    // Convert CSV to JSON
                    const json = csvToJson(csv);

                    params.data = csv;
                    params.jsonRowData = json;
                    params.jsonData = groupByIdentifier(params.jsonRowData);

                    console.log(json, "json file===============");

                    //console.log(params.jsonData);

                    buildFirstSelect();
                    buildSecondSelect();
                    buildThirdSelect();

                })
                .catch(error => console.error('Error fetching data:', error));

        }

        // build collection select (1st)
        const buildFirstSelect = () => {
            // Create the custom dropdown container
            const dropdownContainer = document.createElement('div');
            dropdownContainer.className = 'custom-dropdown select-collection';

            // Create the button
            const dropdownBtn = document.createElement('button');
            dropdownBtn.className = 'dropdown-btn';
            dropdownBtn.innerHTML = '<span>SELECT COLLECTION</span>';

            // Create the SVG element
            const svgNamespace = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNamespace, "svg");

            // Set attributes for the SVG element
            svg.setAttribute("fill", "#000000");
            svg.setAttribute("version", "1.1");
            svg.setAttribute("id", "Layer_1");
            svg.setAttribute("xmlns", svgNamespace);
            svg.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");
            svg.setAttribute("width", "20px");
            svg.setAttribute("height", "20px");
            svg.setAttribute("viewBox", "0 0 100 100");
            svg.setAttribute("enable-background", "new 0 0 100 100");
            svg.setAttribute("xml:space", "preserve");

            // Create the <g> element
            const g = document.createElementNS(svgNamespace, "g");

            // Create the <path> element
            const path = document.createElementNS(svgNamespace, "path");
            path.setAttribute("d", "M78.466,35.559L50.15,63.633L22.078,35.317c-0.777-0.785-2.044-0.789-2.828-0.012s-0.789,2.044-0.012,2.827L48.432,67.58 c0.365,0.368,0.835,0.563,1.312,0.589c0.139,0.008,0.278-0.001,0.415-0.021c0.054,0.008,0.106,0.021,0.16,0.022 c0.544,0.029,1.099-0.162,1.515-0.576l29.447-29.196c0.785-0.777,0.79-2.043,0.012-2.828S79.249,34.781,78.466,35.559z");

            // Append the <path> to the <g>
            g.appendChild(path);

            // Append the <g> to the SVG
            svg.appendChild(g);

            // Create the dropdown content container
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';

            // Append the button and content to the container
            dropdownContainer.appendChild(dropdownBtn);
            dropdownBtn.appendChild(svg);
            dropdownContainer.appendChild(dropdownContent);

            for (let identifier in params.jsonData){
                if(params.jsonData[identifier].dicontinued == 'False') {
                    let colOption = document.createElement('div');
                    colOption.className = 'dropdown-item';
                    colOption.setAttribute('value', params.jsonData[identifier].Identifier);
                    colOption.textContent = params.jsonData[identifier].Collection;

                    dropdownContent.appendChild(colOption);
                }
            }

            const newcolOption = document.createElement("div");  // Create a new div element
            newcolOption.className = 'dropdown-item retired-item';
            newcolOption.textContent = "Retired Collections";
            dropdownContent.appendChild(newcolOption);

            for (let identifier in params.jsonData){
                if(params.jsonData[identifier].dicontinued == 'TRUE') {
                    let colOption = document.createElement('div');
                    colOption.className = 'dropdown-item disable';
                    colOption.setAttribute('value', params.jsonData[identifier].Identifier);
                    colOption.textContent = params.jsonData[identifier].Collection;

                    dropdownContent.appendChild(colOption);
                }
            }

            document.querySelectorAll('.strapengine__collection')[0].appendChild(wrapInDiv(dropdownContainer));
            params.selectedCollection = '';

            dropdownContainer.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    const collection = this.getAttribute('value');
                    console.log(collection, "collection===========");
                    params.selectedCollection = collection;

                    // Assuming params.jsonRowData is an array and params.selectedCollection is a valid Identifier
                    const selectedIdentifier = params.selectedCollection;

                    // Find the relevant data entry by Identifier
                    const selectedEntry = params.jsonRowData.find(entry => entry.Identifier === selectedIdentifier);

                    if (selectedEntry) {
                        // Log the entire entry to debug its structure
                        console.log('Selected Entry:', selectedEntry);

                        // Check if 'Lugs Width' exists in the selected entry
                        const lugsWidth = selectedEntry['Lugs width'];

                        if (lugsWidth) {
                            // Find the button element
                            const button = document.querySelector(".strap-add-to-cart .choose--btn .button");

                            if (button) {
                                // Set the href attribute with the lugs width value
                                button.setAttribute(
                                "href",
                                `/collections/straps/?q=&options%5Bprefix%5D=last&filter.p.m.custom.lugs_width=${encodeURIComponent(lugsWidth)}+mm`
                                );
                            } else {
                                console.error("Button element not found");
                            }
                        } else {
                            console.error("'Lugs Width' is empty for the selected entry");
                        }
                    } else {
                        console.error("No entry found for the selected Identifier");
                    }

                    document.querySelectorAll('.custom-dropdown.select-modal').forEach(element => element.remove()); // remove model select and rebuild
                    document.querySelectorAll('.custom-dropdown.select-strap').forEach(element => element.remove());  // remove strap select and rebuild
                    buildSecondSelect();    
                    buildThirdSelect();
                });
            });

            // Initialize all dropdowns
            buildDropdownCollection();
            buildDropdownModel();
        }

        // build model select (2nd)
        const buildSecondSelect = () => {
            console.log(params.selectedCollection, "selected collection=============================");
            // Create the custom dropdown container
            const dropdownContainer = document.createElement('div');
            dropdownContainer.className = 'custom-dropdown select-modal';

            // Create the button
            const dropdownBtn = document.createElement('button');
            dropdownBtn.className = 'dropdown-btn';
            dropdownBtn.innerHTML = '<span>SELECT MODEL</span>';

            // Create the SVG element
            const svgNamespace = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNamespace, "svg");

            // Set attributes for the SVG element
            svg.setAttribute("fill", "#000000");
            svg.setAttribute("version", "1.1");
            svg.setAttribute("id", "Layer_1");
            svg.setAttribute("xmlns", svgNamespace);
            svg.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");
            svg.setAttribute("width", "20px");
            svg.setAttribute("height", "20px");
            svg.setAttribute("viewBox", "0 0 100 100");
            svg.setAttribute("enable-background", "new 0 0 100 100");
            svg.setAttribute("xml:space", "preserve");

            // Create the <g> element
            const g = document.createElementNS(svgNamespace, "g");

            // Create the <path> element
            const path = document.createElementNS(svgNamespace, "path");
            path.setAttribute("d", "M78.466,35.559L50.15,63.633L22.078,35.317c-0.777-0.785-2.044-0.789-2.828-0.012s-0.789,2.044-0.012,2.827L48.432,67.58 c0.365,0.368,0.835,0.563,1.312,0.589c0.139,0.008,0.278-0.001,0.415-0.021c0.054,0.008,0.106,0.021,0.16,0.022 c0.544,0.029,1.099-0.162,1.515-0.576l29.447-29.196c0.785-0.777,0.79-2.043,0.012-2.828S79.249,34.781,78.466,35.559z");

            // Append the <path> to the <g>
            g.appendChild(path);

            // Append the <g> to the SVG
            svg.appendChild(g);

            // Create the dropdown content container
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';

            // Append the button and content to the container
            dropdownContainer.appendChild(dropdownBtn);
            dropdownBtn.appendChild(svg);
            dropdownContainer.appendChild(dropdownContent);

            // const colSelect = document.createElement('select');
            if (
                params.jsonData &&
                params.selectedCollection in params.jsonData &&
                params.jsonData[params.selectedCollection].Models
            ) {
                const models = params.jsonData[params.selectedCollection].Models;
                
                for (let identifier in models){
                    if(models[identifier].Discontinued == 'False') {
                        let name = models[identifier]['Model Name'];
                        let modelImage = models[identifier]['Image'];
        
                        let colOption = document.createElement('div');
                        colOption.className = 'dropdown-item';
                        colOption.setAttribute('value', name);
                        colOption.textContent = name;
        
                        dropdownContent.appendChild(colOption);
        
                        console.log(modelImage, "modelImage==============");
                        // create image tag 
                        if (modelImage && modelImage !== '') {
                            const modelImageURL = "https://cdn.shopify.com/s/files/1/2372/2167/files/" + modelImage;
                            const img = document.createElement('img');
                            img.src = modelImageURL;
        
                            colOption.setAttribute('data-image', modelImageURL);
                            colOption.appendChild(img);
                        }
                    }
                }

                const newcolOption = document.createElement("div");  // Create a new div element
                newcolOption.className = 'dropdown-item retired-item';
                newcolOption.textContent = "Retired Models";
                dropdownContent.appendChild(newcolOption);

                for (let identifier in models){
                    if(models[identifier].Discontinued == 'TRUE') {
                        let name = models[identifier]['Model Name'];
                        let modelImage = models[identifier]['Image'];
        
                        let colOption = document.createElement('div');
                        colOption.className = 'dropdown-item disable';
                        colOption.setAttribute('value', name);
                        colOption.textContent = name;
        
                        dropdownContent.appendChild(colOption);
        
                        console.log(modelImage, "modelImage==============");
                        // create image tag 
                        if (modelImage && modelImage !== '') {
                            const modelImageURL = "https://cdn.shopify.com/s/files/1/2372/2167/files/" + modelImage;
                            const img = document.createElement('img');
                            img.src = modelImageURL;
        
                            colOption.setAttribute('data-image', modelImageURL);
                            colOption.appendChild(img);
                        }
                    }
                }
            } else {
                console.error('The selected collection or Models property does not exist.');
            }

            document.querySelectorAll('.strapengine__collection')[0].appendChild(wrapInDiv(dropdownContainer));
            params.selectedModel = '';

            dropdownContainer.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    const modal = this.getAttribute('value');
                    params.selectedModel = modal;
                    if(item.classList.contains('disable')) {
                        window.location.href = `/collections/straps/?q=&options%5Bprefix%5D=last&filter.p.m.custom.lugs_width=${params.jsonData[params.selectedCollection].Models[params.selectedModel]['Lugs Width']}+mm`;
                    } else {
                        const getModalImage = this.getAttribute('data-image');
                        if (getModalImage !== null && getModalImage.trim() !== '') {
                            document.querySelector('.starp-img-inner .strap__image img').classList.add("remove");
                            document.querySelector('.starp-img-inner .model-img').innerHTML = '';
                            document.querySelector('.starp-img-inner .model-img').innerHTML = `<img src="${getModalImage}">`;
                        }
                        document.querySelectorAll('.custom-dropdown.select-strap').forEach(element => element.remove());  // remove strap select and rebuild
                        buildThirdSelect();
                    }
                });
            });

            // Initialize all dropdowns
            buildDropdownModel();
        }

        // build strap select (3rd)
        const buildThirdSelect = () => {
            console.log(params.selectedModel, "selected model=============================");
            // Create the custom dropdown container
            const dropdownContainer = document.createElement('div');
            dropdownContainer.className = 'custom-dropdown select-strap';

            // Create the button
            const dropdownBtn = document.createElement('button');
            dropdownBtn.className = 'dropdown-btn';
            dropdownBtn.innerHTML = '<span>SELECT STRAP</span>';

            // Create the SVG element
            const svgNamespace = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNamespace, "svg");

            // Set attributes for the SVG element
            svg.setAttribute("fill", "#000000");
            svg.setAttribute("version", "1.1");
            svg.setAttribute("id", "Layer_1");
            svg.setAttribute("xmlns", svgNamespace);
            svg.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");
            svg.setAttribute("width", "20px");
            svg.setAttribute("height", "20px");
            svg.setAttribute("viewBox", "0 0 100 100");
            svg.setAttribute("enable-background", "new 0 0 100 100");
            svg.setAttribute("xml:space", "preserve");

            // Create the <g> element
            const g = document.createElementNS(svgNamespace, "g");

            // Create the <path> element
            const path = document.createElementNS(svgNamespace, "path");
            path.setAttribute("d", "M78.466,35.559L50.15,63.633L22.078,35.317c-0.777-0.785-2.044-0.789-2.828-0.012s-0.789,2.044-0.012,2.827L48.432,67.58 c0.365,0.368,0.835,0.563,1.312,0.589c0.139,0.008,0.278-0.001,0.415-0.021c0.054,0.008,0.106,0.021,0.16,0.022 c0.544,0.029,1.099-0.162,1.515-0.576l29.447-29.196c0.785-0.777,0.79-2.043,0.012-2.828S79.249,34.781,78.466,35.559z");

            // Append the <path> to the <g>
            g.appendChild(path);

            // Append the <g> to the SVG
            svg.appendChild(g);

            // Create the dropdown content container
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';

            // Append the button and content to the container
            dropdownContainer.appendChild(dropdownBtn);
            dropdownBtn.appendChild(svg);
            dropdownContainer.appendChild(dropdownContent);

            if (
                params.jsonData &&
                params.selectedCollection in params.jsonData &&
                params.selectedModel in params.jsonData[params.selectedCollection].Models
            ) {
                const selectedModelStrap = params.jsonData[params.selectedCollection].Models[params.selectedModel];
                const strapCollection = selectedModelStrap['StrapCollection'];
                if (strapCollection) {
                    // Fetch the collection data
                    fetch(`/collections/${strapCollection}?view=strap_filter`)
                        .then((response) => response.text()) // Get response as text since it's HTML
                        .then(data => {
                            // Create a temporary DOM element to parse HTML
                            let parser = new DOMParser();
                            let doc = parser.parseFromString(data, "text/html");
                            let collectionDataHTML = doc.querySelector("#collection_data").innerHTML;
                            // Create a temporary container to convert the HTML string into a Node
                            let tempDiv = document.createElement("div");
                            tempDiv.innerHTML = collectionDataHTML;

                            // Append all child nodes to dropdownContent
                            while (tempDiv.firstChild) {
                                dropdownContent.appendChild(tempDiv.firstChild);
                            }
                        })
                        .catch(error => console.error('Error fetching collection data:', error));

                    // // Fetch the collection data
                    // fetch(`/collections/${strapCollection}/products.json`)
                    //     .then(response => response.json())
                    //     .then(data => {
                    //         console.log('API Response:', data); // Add this line to inspect the API response
                    //         const products = data.products;

                    //         products.forEach(product => {
                    //             const productTitle = product.title;
                    //             const variants = product.variants;
                    //             const handle = product.handle;
                    //             const productImage = product.images[0].src;

                    //             if (variants.length > 0) {
                    //                 const variant = variants[0]; // Assuming you want the first variant
                    //                 const variantId = variant.id;
                    //                 const variantPrice = variant.price;

                    //                 const colOption = document.createElement('div');
                    //                 colOption.className = 'dropdown-item';
                    //                 colOption.setAttribute('value', variantId);
                    //                 colOption.textContent = `${productTitle} (${variantPrice})`;
                    //                 colOption.setAttribute('data-handle', handle);

                    //                 // create image tag 
                    //                 if (productImage && productImage !== '') {
                    //                     const img = document.createElement('img');
                    //                     img.src = productImage;
                    
                    //                     colOption.setAttribute('data-image', productImage);
                    //                     colOption.appendChild(img);
                    //                     console.log(productImage, "productImage found====");
                    //                 } else {
                    //                     console.log("productImage not found====");
                    //                 }

                    //                 dropdownContent.appendChild(colOption);
                    //             }
                    //         });
                    //     })
                    //     .catch(error => console.error('Error fetching collection data:', error));


                    document.querySelector(".strap-add-to-cart .choose--btn .button").setAttribute("href", `/collections/straps/?q=&options%5Bprefix%5D=last&filter.p.m.custom.lugs_width=${selectedModelStrap['Lugs Width']}+mm`);
                } else {
                    console.error('StrapCollection is not defined for the selected model.');
                }
            } else {
                console.error('The selected collection, model, or strap collection property does not exist.');
            }

            document.querySelectorAll('.strapengine__strap')[0].appendChild(wrapInDiv(dropdownContainer));

            console.log('Adding event listeners to dropdown items');
            dropdownContainer.addEventListener('click', function(event) {
              console.log("params", params);
              console.log("event click", selectedEntry);

                // Check if the clicked element has the 'dropdown-item' class
                if (event.target.classList.contains('dropdown-item')) {
                    const p_variant_id = event.target.getAttribute('value');
                    const p_Handle = event.target.getAttribute('data-handle');
                    const p_Name = event.target.textContent;
                    const p_straps_img = event.target.getAttribute('data-straps');
                    const p_t10_straps_img = event.target.getAttribute('data-t10-straps') || "";
                    dropdownBtn.querySelector('span').innerHTML = p_Name;

                    const span = dropdownBtn.querySelector('span');
                    const imageModal = event.target.getAttribute('data-image');
                    if (imageModal) {
                        const existingImg = span.querySelector('img');
                        if (existingImg) {
                            existingImg.src = imageModal;
                        } else {
                            const modelImgElement = document.createElement('img');
                            modelImgElement.src = imageModal;
                            modelImgElement.width = 35;
                            modelImgElement.height = 35;
                            span.appendChild(modelImgElement);
                        }
                    }
                    const strapImgElement = document.querySelector('.starp-img .strap__image img');
                    if (strapImgElement) {
                      if (params.selectedModel.includes('T10')) {
                        strapImgElement.setAttribute('src', p_t10_straps_img);
                      } else {
                        strapImgElement.setAttribute('src', p_straps_img);
                      }
                        document.querySelector('.starp-img-inner').classList.add("add");
                    }
                    // getProductImg(p_Handle);
                    document.querySelector(".strap-add-to-cart .strap--details .button").setAttribute("href", `/products/${p_Handle}`);
                    document.querySelector(".strap-add-to-cart .strap--details").style.display = 'block';
                    document.querySelector(".strap-add-to-cart .product-form__submit").style.display = 'block';
                    document.querySelector(".strap-add-to-cart .choose--btn").style.display = 'none';
                    document.querySelector(".strap-add-to-cart input[name='id']").setAttribute('value', p_variant_id);
                    document.querySelector(".strap-add-to-cart .product-form__submit").removeAttribute('disabled');
                    // Find the closest dropdown container
            
                    if (dropdownContainer) {
                        // Find and hide the dropdown content
                        const dropdownContent = dropdownContainer.querySelector('.dropdown-content');
                        if (dropdownContent) {
                            dropdownContent.classList.remove('show');
                        } else {
                            console.warn('No dropdown content found within the dropdown container.');
                        }
                    } else {
                        console.warn('No dropdown container found for the clicked item.');
                    }
                }
            });

            // Initialize all dropdowns
            buildDropdownStrap();
        }

        const wrapInDiv = (obj) => {
            const div = document.createElement('div');
            div.appendChild(obj);
            return div;
        }

        const groupByIdentifier = (data) => {
            return data.reduce((result, item) => {
                const id = item['Identifier'];
                const discontinuedCollection = item['Discontinued collection'] || 'False';
                const collection = item['Collection name'];
                const modelName = item['Model name'];
                const discontinuedModel = item ['Discontinued model'];

                // Initialize the identifier entry if it doesn't exist
                if (!result[id]) {
                    result[id] = { Identifier: id, Collection: collection, dicontinued: discontinuedCollection ,Models: {} };
                }
        
                // Initialize the model entry if it doesn't exist
                if (modelName && !result[id].Models[modelName]) {
                    result[id].Models[modelName] = {
                        'Model Name': modelName,
                        'Discontinued' : discontinuedModel || 'False',
                        'Image': item['Image'] || '',
                        'Lugs Width': item['Lugs width'] || '',  
                        'Model Size': item['Model size'] || '',
                        'StrapCollection': item['Strap collection'] || ''
                    };
                }

                return result;
            }, {});
        }

        /**
         * Convert CSV to JSON
         * @param {string} csv - CSV data as a string
         * @returns {Object[]} - Array of JSON objects
         */
        const csvToJson = (csv) => {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');

            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, i) => {
                    obj[header.trim()] = values[i].trim();
                    return obj;
                }, {});
            });
        }


        return {
            int:int
        }


    })();

    strapEngine.int();

    // CUSTOM DROPDOWN OPEN/CLOSE JS START
  
    function buildDropdownCollection() {
        const dropdownButtonCollection = document.querySelector('.select-collection .dropdown-btn');
        const dropdownContentCollection = document.querySelector('.select-collection .dropdown-content');

        if (!dropdownButtonCollection || !dropdownContentCollection) {
            console.warn('Collection dropdown elements not found.');
            return;
        }

        function toggleDropdownContent() {
            dropdownContentCollection.classList.toggle('show');
        }

        dropdownButtonCollection.addEventListener('click', toggleDropdownContent);

        document.querySelectorAll('.select-collection .dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const span = dropdownButtonCollection.querySelector('span');
                const value = this.getAttribute('value');

                span.textContent = value;
                const imageModal = this.getAttribute('data-image');
                if (imageModal) {
                    const existingImg = span.querySelector('img');
                    if (existingImg) {
                        existingImg.src = imageModal;
                    } else {
                        const modelImgElement = document.createElement('img');
                        modelImgElement.src = imageModal;
                        modelImgElement.width = 35;
                        modelImgElement.height = 35;
                        span.appendChild(modelImgElement);
                    }
                } else {
                    span.querySelector('img')?.remove();
                }

                dropdownContentCollection.classList.remove('show');
            });
        });

        window.addEventListener('click', function(event) {
            if (!event.target.closest('.select-collection')) {
                dropdownContentCollection.classList.remove('show');
            }
        });

        setTimeout(function() {
            dropdownContentCollection.querySelector(".dropdown-item:not(.retired-item):first-child").click();
        }, 200);
    }

    function buildDropdownModel() {
        const dropdownButtonModel = document.querySelector('.select-modal .dropdown-btn');
        const dropdownContentModel = document.querySelector('.select-modal .dropdown-content');

        if (!dropdownButtonModel || !dropdownContentModel) {
            console.warn('Model dropdown elements not found.');
            return;
        }

        function toggleDropdownContent() {
            dropdownContentModel.classList.toggle('show');
        }

        dropdownButtonModel.addEventListener('click', toggleDropdownContent);

        document.querySelectorAll('.select-modal .dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const span = dropdownButtonModel.querySelector('span');
                const value = this.getAttribute('value');

                span.textContent = value;
                const imageModal = this.getAttribute('data-image');
                if (imageModal) {
                    const existingImg = span.querySelector('img');
                    if (existingImg) {
                        existingImg.src = imageModal;
                    } else {
                        const modelImgElement = document.createElement('img');
                        modelImgElement.src = imageModal;
                        modelImgElement.width = 35;
                        modelImgElement.height = 35;
                        span.appendChild(modelImgElement);
                    }
                } else {
                    span.querySelector('img')?.remove();
                }

                dropdownContentModel.classList.remove('show');
            });
        });

        window.addEventListener('click', function(event) {
            if (!event.target.closest('.select-modal')) {
                dropdownContentModel.classList.remove('show');
            }
        });

        setTimeout(function() {
            dropdownContentModel.querySelector(".dropdown-item:not(.retired-item):first-child").click();
        }, 100);
    }

    function buildDropdownStrap() {
        const dropdownButtonStrap = document.querySelector('.select-strap .dropdown-btn');
        const dropdownContentStrap = document.querySelector('.select-strap .dropdown-content');

        if (!dropdownButtonStrap || !dropdownContentStrap) {
            console.warn('Strap dropdown elements not found.');
            return;
        }

        function toggleDropdownContent() {
            dropdownContentStrap.classList.toggle('show');
        }

        dropdownButtonStrap.addEventListener('click', toggleDropdownContent);

        document.querySelectorAll('.select-strap .dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const span = dropdownButtonStrap.querySelector('span');
                const value = this.getAttribute('value');

                span.textContent = value;
                const imageModal = this.getAttribute('data-image');
                if (imageModal) {
                    const existingImg = span.querySelector('img');
                    if (existingImg) {
                        existingImg.src = imageModal;
                    } else {
                        const modelImgElement = document.createElement('img');
                        modelImgElement.src = imageModal;
                        modelImgElement.width = 35;
                        modelImgElement.height = 35;
                        span.appendChild(modelImgElement);
                    }
                } else {
                    span.querySelector('img')?.remove();
                    console.log("dropdown image not found===========");
                }

                dropdownContentStrap.classList.remove('show');
            });
        });

        window.addEventListener('click', function(event) {
            if (!event.target.closest('.select-strap')) {
                dropdownContentStrap.classList.remove('show');
            }
        });

        setTimeout(function() {
            dropdownContentStrap.querySelector(".dropdown-item:not(.retired-item):first-child").click();
            document.querySelector('.starp-img-inner').classList.remove("loading");
        }, 1000);
    }

    function getProductImg(p_Handle) {
        const productUrl = `${location.origin}/products/${p_Handle}?view=product_img`;
        console.log("product_url == ", productUrl);
    
        // Use Fetch API to make the GET request
        fetch(productUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                // Create a temporary container to hold the fetched data
                const tempDiv = document.createElement('div');
                tempDiv.className = 'getProductImg-apiData hide';
                tempDiv.innerHTML = data;
    
                // Append the temporary container to the body
                document.body.appendChild(tempDiv);
     
                // Find the image source in the fetched data
                const imgElement = tempDiv.querySelector('.current_product_data img');
                if (imgElement) {
                    const currentProductStrapCustomizeImg = imgElement.getAttribute('src');
                    const strapImgElement = document.querySelector('.starp-img .strap__image img');
                    if (strapImgElement) {
                        strapImgElement.setAttribute('src', currentProductStrapCustomizeImg);
                        document.querySelector('.starp-img-inner').classList.add("add");
                    }
                }
    
                // Remove the temporary container from the body
                document.body.removeChild(tempDiv);
            })
            .catch(error => {
                console.error("Error fetching product information:", error);
            });
    }  

    // CUSTOM DROPDOWN OPEN/CLOSE JS END

</script>

{% schema %}
{
    "name": "Starp Customization",
    "settings": [
      {
        "type": "image_picker",
        "id": "strap_img",
        "label": "Strap Image"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "Customize Your Strap"
      },
      {
        "type": "richtext",
        "id": "desc",
        "label": "Description",
        "default": "<p>Choose your favorite strap design and customize your look.</p>"
      },
      {
        "type": "text",
        "id": "watch_title",
        "label": "Watch Title",
        "default": "Watch Customization"
      },
      {
        "type": "text",
        "id": "watch_text",
        "label": "Watch Text"
      },
      {
        "type": "text",
        "id": "strap_title",
        "label": "Strap Title",
        "default": "Strap Options"
      },
      {
        "type": "text",
        "id": "strap_text",
        "label": "Strap Text"
      },
      {
        "type": "text",
        "id": "extra_title",
        "label": "Strap Title",
        "default": "Extra Line"
      },
      {
        "type": "text",
        "id": "extra_text",
        "label": "Extra Text"
      },
      {
        "type": "richtext",
        "id": "bottom_desc",
        "label": "Description",
        "default": "<p>Choose your favorite strap design and customize your look.</p>"
      },
      {
        "type": "header",
        "content": "Buttons"
      },
      {
        "type": "text",
        "id": "button_label_1",
        "label": "Button Label"
      },
      {
        "type": "url",
        "id": "button_link_1",
        "label": "Button Link"
      },
      {
        "type": "text",
        "id": "button_label_2",
        "label": "Button Label"
      },
      {
        "type": "url",
        "id": "button_link_2",
        "label": "Button Link"
      }
    ],
    "presets": [
      {
        "name": "Starp Customization",
        "category": "Customization"
      }
    ]
  }
{% endschema %}